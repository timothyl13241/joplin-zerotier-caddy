networks:
  app-network:
  transcribe-network:
  shared-network:

volumes:
  pg_data:
  transcribe_pg_data:
  caddy_data:
  caddy_config:
  zerotier_data:

services:
  zerotier:
    image: zerotier/zerotier:latest
    container_name: zerotier
    network_mode: host
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    volumes:
      - zerotier_data:/var/lib/zerotier-one
    restart: unless-stopped
    # After start:
    # docker exec zerotier zerotier-cli join <NETWORK_ID>
    # Authorize the member in your controller, then set ZT_IP in ./caddy/env

  caddy:
    build:
      context: ./caddy
      dockerfile: Dockerfile
    container_name: caddy
    network_mode: host
    env_file:
      - ./caddy/env   # CF_API_TOKEN and ZT_IP
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped
    depends_on:
      - app

  db:
    image: postgres:16
    container_name: joplin-postgres
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${POSTGRES_DATABASE}
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - app-network
    # No host port exposure

  app:
    image: joplin/server:latest
    container_name: joplin
    depends_on:
      - db
      - transcribe
    environment:
      - APP_PORT=22300
      - APP_BASE_URL=${APP_BASE_URL}  # e.g., https://joplin.internal.example.com
      - DB_CLIENT=pg
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_HOST=db
      - TRANSCRIBE_API_KEY=${TRANSCRIBE_API_KEY}
      - TRANSCRIBE_BASE_URL=http://transcribe:4567
      - TRANSCRIBE_ENABLED=${TRANSCRIBE_ENABLED:-0}
    ports:
      - "127.0.0.1:22300:22300"  # only reachable by Caddy on the host
    networks:
      - app-network
      - shared-network
    restart: unless-stopped

  transcribe-db:
    image: postgres:16
    container_name: joplin-transcribe-db
    environment:
      - POSTGRES_PASSWORD=${QUEUE_DATABASE_PASSWORD}
      - POSTGRES_USER=${QUEUE_DATABASE_USER}
      - POSTGRES_DB=${QUEUE_DATABASE_NAME}
    command: -p ${QUEUE_DATABASE_PORT:-5433}
    volumes:
      - transcribe_pg_data:/var/lib/postgresql/data
    networks:
      - transcribe-network
    # No host port exposure

  transcribe:
    image: joplin/transcribe:latest
    container_name: joplin-transcribe
    depends_on:
      - transcribe-db
    environment:
      - APP_PORT=4567
      - DB_CLIENT=pg
      - QUEUE_DATABASE_NAME=${QUEUE_DATABASE_NAME}
      - QUEUE_DATABASE_USER=${QUEUE_DATABASE_USER}
      - QUEUE_DATABASE_PASSWORD=${QUEUE_DATABASE_PASSWORD}
      - QUEUE_DATABASE_PORT=${QUEUE_DATABASE_PORT:-5433}
      - QUEUE_DATABASE_HOST=transcribe-db
      - API_KEY=${TRANSCRIBE_API_KEY}
      - HTR_CLI_IMAGES_FOLDER=${HTR_CLI_IMAGES_FOLDER}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HTR_CLI_IMAGES_FOLDER}:/app/packages/transcribe/images
    networks:
      - transcribe-network
      - shared-network
    # No host port exposure
    restart: unless-stopped
